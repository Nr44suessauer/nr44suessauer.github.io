import{d as X,u as H,a as V,r as L,o as Y,_ as j,b as ee,c as R,e as q,f as K,g as F,n as te,F as ne,h as m,w as O,T as J,t as oe,i as B,j as ie,k as se,l as D,q as ae,m as M,p as U,s as re,v as E,x as de,y as z,z as W}from"./1R1bKoqt.js";import{r as le}from"./bi5dneJ6.js";const ue={key:0},pe={key:0},ce={id:"__preview_loader"},fe=X({__name:"ContentPreviewMode",props:{previewToken:{type:String,required:!0},apiURL:{type:String,required:!0},syncPreview:{type:Function,required:!0},requestPreviewSyncAPI:{type:Function,required:!0}},setup(s){const i=s,u=["__nuxt_preview","__preview_enabled"],v=H(),h=V(),d=L(!0),_=L(!1),o=L(!1),p=L("");let a;const y=async()=>{B("previewToken").value="",window.sessionStorage.removeItem("previewToken"),await h.replace({query:{preview:void 0}}),window.location.reload()},b=async S=>{const r=await i.syncPreview(S);if(o.value!==!0){if(!r){setTimeout(()=>b(S),1e3);return}B("previewToken").value&&(o.value=!0,await h.replace({query:{}}),v.callHook("nuxt-studio:preview:ready"),window.parent&&window.self!==window.parent&&a.disconnect())}};return Y(async()=>{a=(await j(()=>import("./BlRhkrN0.js"),[],import.meta.url)).connect(`${i.apiURL}/preview`,{transports:["websocket","polling"],auth:{token:i.previewToken}});let r;a.on("connect",()=>{r=setTimeout(()=>{o.value||(r=setTimeout(()=>{p.value="Preview sync timed out",o.value=!1},3e4),a.emit("draft:requestSync"))},3e4)});const I=()=>{r&&(clearTimeout(r),r=null)};a.on("draft:sync",async P=>{if(I(),!P){try{a.once("draft:ready",()=>{a.emit("draft:requestSync")}),await i.requestPreviewSyncAPI()}catch(A){switch(I(),A.response.status){case 404:p.value="Preview draft not found",o.value=!1;break;default:p.value="An error occurred while syncing preview",o.value=!1}}return}b(P)}),a.on("draft:unauthorized",()=>{I(),p.value="Unauthorized preview token",o.value=!1}),a.on("disconnect",()=>{I()}),document.body.classList.add(...u),a.on("draft:update",P=>{_.value=!0,i.syncPreview(P),_.value=!1})}),ee(()=>{document.body.classList.remove(...u)}),(S,r)=>(q(),R("div",null,[d.value?(q(),R("div",{key:0,id:"__nuxt_preview",class:te({__preview_ready:o.value,__preview_refreshing:_.value})},[o.value?(q(),R(ne,{key:0},[r[0]||(r[0]=m("svg",{viewBox:"0 0 90 90",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[m("path",{d:"M50.0016 71.0999h29.2561c.9293.0001 1.8422-.241 2.6469-.6992.8047-.4582 1.4729-1.1173 1.9373-1.9109.4645-.7936.7088-1.6939.7083-2.6102-.0004-.9162-.2455-1.8163-.7106-2.6095L64.192 29.713c-.4644-.7934-1.1325-1.4523-1.937-1.9105-.8046-.4581-1.7173-.6993-2.6463-.6993-.9291 0-1.8418.2412-2.6463.6993-.8046.4582-1.4726 1.1171-1.937 1.9105l-5.0238 8.5861-9.8224-16.7898c-.4648-.7934-1.1332-1.4522-1.938-1.9102-.8047-.4581-1.7176-.6992-2.6468-.6992-.9292 0-1.842.2411-2.6468.6992-.8048.458-1.4731 1.1168-1.9379 1.9102L6.56062 63.2701c-.46512.7932-.71021 1.6933-.71061 2.6095-.00041.9163.24389 1.8166.70831 2.6102.46443.7936 1.1326 1.4527 1.93732 1.9109.80473.4582 1.71766.6993 2.64686.6992h18.3646c7.2763 0 12.6422-3.1516 16.3345-9.3002l8.9642-15.3081 4.8015-8.1925 14.4099 24.6083H54.8058l-4.8042 8.1925ZM29.2077 62.899l-12.8161-.0028L35.603 30.0869l9.5857 16.4047-6.418 10.9645c-2.4521 3.9894-5.2377 5.4429-9.563 5.4429Z",fill:"currentColor"})],-1)),r[1]||(r[1]=m("span",null,"Preview mode enabled",-1)),m("button",{onClick:y}," Close ")],64)):K("",!0)],2)):K("",!0),F(J,{name:"preview-loading"},{default:O(()=>[d.value&&!o.value&&!p.value?(q(),R("div",ue,[r[4]||(r[4]=m("div",{id:"__preview_background"},null,-1)),m("div",{id:"__preview_loader"},[r[2]||(r[2]=m("svg",{id:"__preview_loading_icon",width:"32",height:"32",viewBox:"0 0 24 24"},[m("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 0 0 4.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 0 1-15.357-2m15.357 2H15"})],-1)),r[3]||(r[3]=m("p",null,"Initializing the preview...",-1)),m("button",{onClick:y}," Cancel ")])])):K("",!0)]),_:1}),F(J,{name:"preview-loading"},{default:O(()=>[p.value?(q(),R("div",pe,[r[5]||(r[5]=m("div",{id:"__preview_background"},null,-1)),m("div",ce,[m("p",null,oe(p.value),1),m("button",{onClick:y}," Exit preview ")])])):K("",!0)]),_:1})]))}}),ve=ie(fe,[["__scopeId","data-v-36384eba"]]),we=(s=[],i,u)=>{const v=[...i||[]],h=[...u||[]],d=JSON.parse(JSON.stringify(s));for(const o of v)if(o.oldPath)if(h.splice(h.findIndex(a=>a.path===o.oldPath),1),v.find(a=>a.path===o.oldPath))d.push({path:o.path,parsed:o.parsed});else{const a=d.find(y=>y.path===o.oldPath);a&&(a.path=o.path,o.parsed?a.parsed=o.parsed:o.pathMeta&&["_file","_path","_id","_locale"].forEach(y=>{a.parsed[y]=o.pathMeta[y]}))}else if(o.new)d.push({path:o.path,parsed:o.parsed});else{const p=d.find(a=>a.path===o.path);p&&Object.assign(p,{path:o.path,parsed:o.parsed})}for(const o of h)d.splice(d.findIndex(p=>p.path===o.path),1);const _=new Intl.Collator(void 0,{numeric:!0});return d.sort((o,p)=>_.compare(o.path,p.path)),d},C={appConfig:"app.config.ts",tokensConfig:"tokens.config.ts"},me=s=>{let i;return(...u)=>(i||(i=s()),i)};function Z(s,i){for(const u in s){const v=i[u];u in i||delete s[u],v!==null&&typeof v=="object"&&Z(s[u],i[u])}}function G(s,i){for(const u in i){const v=i[u];v!==null&&typeof v=="object"?(s[u]=s[u]||{},G(s[u],v)):s[u]=v}}const ye=me(()=>JSON.parse(JSON.stringify(W()))),Ce=()=>{const s=H(),{studio:i,content:u}=se().public,v=ye();let h;const d=D("studio-client-db",()=>null),_=D("studio-preview-db-files",()=>[]);d.value||(s.hook("content:storage",e=>{d.value=e}),ae("/non-existing-path").findOne());const o=async(e,n,l=!0)=>{const f=window.sessionStorage.getItem("previewToken"),w=await e.getKeys(`${f}:`);await Promise.all(w.map(c=>e.removeItem(c)));const t=new Set(n.map(c=>c.parsed._id.split(":").shift()));await e.setItem(`${f}$`,JSON.stringify({ignoreSources:Array.from(t)})),await Promise.all(n.map(c=>e.setItem(`${f}:${c.parsed._id}`,JSON.stringify(c.parsed))))},p=e=>{const n=E(s,W);G(n,z(e,v)),e||Z(n,v)},a=e=>{var l,f,w,t;const n=(t=(w=(f=(l=s==null?void 0:s.vueApp)==null?void 0:l._context)==null?void 0:f.config)==null?void 0:w.globalProperties)==null?void 0:t.$pinceauTheme;!n||!(n!=null&&n.updateTheme)||(h||(h=JSON.parse(JSON.stringify((n==null?void 0:n.theme.value)||{}))),E(s,n.updateTheme,[z(e,h)]))},y=async e=>{if(_.value=e.files=e.files||_.value||[],!d.value)return!1;const n=we(e.files,e.additions,e.deletions),l=n.filter(t=>![C.appConfig,C.tokensConfig].includes(t.path));await o(d.value,l,(e.files||[]).length!==0);const f=n.find(t=>t.path===C.appConfig);p(f==null?void 0:f.parsed);const w=n.find(t=>t.path===C.tokensConfig);return a(w==null?void 0:w.parsed),A(),!0},b=async()=>{const e=window.sessionStorage.getItem("previewToken");await $fetch("api/projects/preview/sync",{baseURL:i==null?void 0:i.apiURL,method:"POST",params:{token:e}})},S=()=>{const e=window.sessionStorage.getItem("previewToken"),n=document.createElement("div");n.id="__nuxt_preview_wrapper",document.body.appendChild(n),re(ve,{previewToken:e,apiURL:i==null?void 0:i.apiURL,syncPreview:y,requestPreviewSyncAPI:b}).mount(n)},r=async e=>{var f,w,t;const n=window.sessionStorage.getItem("previewToken");if(!e)return null;e=e.replace(/\/$/,"");let l=await((f=d.value)==null?void 0:f.getItem(`${n}:${e}`));return l||(l=await((w=d.value)==null?void 0:w.getItem(`cached:${e}`))),l||(l=l=await((t=d.value)==null?void 0:t.getItem(e))),l},I=e=>{var l;const n=window.sessionStorage.getItem("previewToken");d.value&&d.value.setItem(`${n}:${(l=e.parsed)==null?void 0:l._id}`,JSON.stringify(e.parsed))},P=async e=>{var l;const n=window.sessionStorage.getItem("previewToken");await((l=d.value)==null?void 0:l.removeItem(`${n}:${e}`))},A=async()=>{if(u!=null&&u.documentDriven){const{pages:e}=E(s,de);for(const n in e.value)e.value[n]&&(e.value[n]=await r(e.value[n]._id))}E(s,le)};return{apiURL:i==null?void 0:i.apiURL,contentStorage:d,syncPreviewFiles:o,syncPreviewAppConfig:p,syncPreviewTokensConfig:a,requestPreviewSynchronization:b,findContentWithId:r,updateContent:I,removeContentWithId:P,requestRerender:A,mountPreviewUI:S,initiateIframeCommunication:Q};function Q(){if(!window.parent||window.self===window.parent)return;const e=V(),n=M(),l=L(""),f=t=>({path:t.path,query:U(t.query),params:U(t.params),fullPath:t.fullPath,meta:U(t.meta)});window.addEventListener("keydown",t=>{(t.metaKey||t.ctrlKey||t.altKey||t.shiftKey)&&window.parent.postMessage({type:"nuxt-studio:preview:keydown",payload:{key:t.key,metaKey:t.metaKey,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey}},"*")}),window.addEventListener("message",async t=>{if(!["https://nuxt.studio","https://dev.nuxt.studio"].includes(t.origin))return;const{type:c,payload:x={}}=t.data||{};switch(c){case"nuxt-studio:editor:file-selected":{const g=await r(x.path);g&&(g._partial||g._path!==M().path&&(l.value=g._path,e.push(g._path)));break}case"nuxt-studio:editor:file-changed":{const{additions:g=[],deletions:$=[]}=x;for(const k of g)await I(k);for(const k of $)await P(k.path);A();break}case"nuxt-studio:preview:sync":{y(x);break}case"nuxt-studio:config:file-changed":{const{additions:g=[],deletions:$=[]}=x,k=g.find(T=>T.path===C.appConfig);k&&p(k==null?void 0:k.parsed),$.find(T=>T.path===C.appConfig)&&p(void 0);const N=g.find(T=>T.path===C.tokensConfig);N&&a(N==null?void 0:N.parsed),$.find(T=>T.path===C.tokensConfig)&&a(void 0);break}}}),s.hook("page:finish",()=>{w()}),s.hook("content:document-driven:finish",({route:t,page:c})=>{t.meta.studio_page_contentId=c==null?void 0:c._id}),s.hook("nuxt-studio:preview:ready",()=>{window.parent.postMessage({type:"nuxt-studio:preview:ready",payload:f(M())},"*"),setTimeout(()=>{w()},100)});function w(){const t=Array.from(window.document.querySelectorAll("[data-content-id]")).map(x=>x.getAttribute("data-content-id")),c=Array.from(new Set([n.meta.studio_page_contentId,...t])).filter(Boolean);if(l.value===c[0]){l.value="";return}window.openContentInStudioEditor(c,{navigate:!0,pageContentId:n.meta.studio_page_contentId})}window.openContentInStudioEditor=(t,c={})=>{window.parent.postMessage({type:"nuxt-studio:preview:navigate",payload:{...f(n),contentIds:t,...c}},"*")}}};export{Ce as useStudio};
