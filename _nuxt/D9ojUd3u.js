import{u as F,a as M,b,q as D,c as W,d as R,r as B,t as A,e as z,f as P,g as G,h as J,i as O}from"./Kwya5N3u.js";import H from"./BsTMkzMu.js";import{r as Q}from"./BmGa1-G_.js";const V=(o=[],s,d)=>{const u=[...s||[]],g=[...d||[]],r=JSON.parse(JSON.stringify(o));for(const i of u)if(i.oldPath)if(g.splice(g.findIndex(l=>l.path===i.oldPath),1),u.find(l=>l.path===i.oldPath))r.push({path:i.path,parsed:i.parsed});else{const l=r.find(y=>y.path===i.oldPath);l&&(l.path=i.path,i.parsed?l.parsed=i.parsed:i.pathMeta&&["_file","_path","_id","_locale"].forEach(y=>{l.parsed[y]=i.pathMeta[y]}))}else if(i.new)r.push({path:i.path,parsed:i.parsed});else{const w=r.find(l=>l.path===i.path);w&&Object.assign(w,{path:i.path,parsed:i.parsed})}for(const i of g)r.splice(r.findIndex(w=>w.path===i.path),1);const C=new Intl.Collator(void 0,{numeric:!0});return r.sort((i,w)=>C.compare(i.path,w.path)),r},v={appConfig:"app.config.ts",tokensConfig:"tokens.config.ts"},X=o=>{let s;return(...d)=>(s||(s=o()),s)};function q(o,s){for(const d in o){const u=s[d];d in s||delete o[d],u!==null&&typeof u=="object"&&q(o[d],s[d])}}function E(o,s){for(const d in s){const u=s[d];u!==null&&typeof u=="object"?(o[d]=o[d]||{},E(o[d],u)):o[d]=u}}const Y=X(()=>JSON.parse(JSON.stringify(O()))),oe=()=>{const o=F(),{studio:s,content:d}=M().public,u=Y();let g;const r=b("studio-client-db",()=>null),C=b("studio-preview-db-files",()=>[]);r.value||(o.hook("content:storage",e=>{r.value=e}),D("/non-existing-path").findOne());const i=async(e,n,a=!0)=>{const c=window.sessionStorage.getItem("previewToken"),f=await e.getKeys(`${c}:`);await Promise.all(f.map(p=>e.removeItem(p)));const t=new Set(n.map(p=>p.parsed._id.split(":").shift()));await e.setItem(`${c}$`,JSON.stringify({ignoreSources:Array.from(t)})),await Promise.all(n.map(p=>e.setItem(`${c}:${p.parsed._id}`,JSON.stringify(p.parsed))))},w=e=>{const n=P(o,O);E(n,J(e,u)),e||q(n,u)},l=e=>{var a,c,f,t;const n=(t=(f=(c=(a=o==null?void 0:o.vueApp)==null?void 0:a._context)==null?void 0:c.config)==null?void 0:f.globalProperties)==null?void 0:t.$pinceauTheme;!n||!(n!=null&&n.updateTheme)||(g||(g=JSON.parse(JSON.stringify((n==null?void 0:n.theme.value)||{}))),P(o,n.updateTheme,[J(e,g)]))},y=async e=>{if(C.value=e.files=e.files||C.value||[],!r.value)return!1;const n=V(e.files,e.additions,e.deletions),a=n.filter(t=>![v.appConfig,v.tokensConfig].includes(t.path));await i(r.value,a,(e.files||[]).length!==0);const c=n.find(t=>t.path===v.appConfig);w(c==null?void 0:c.parsed);const f=n.find(t=>t.path===v.tokensConfig);return l(f==null?void 0:f.parsed),x(),!0},$=async()=>{const e=window.sessionStorage.getItem("previewToken");await $fetch("api/projects/preview/sync",{baseURL:s==null?void 0:s.apiURL,method:"POST",params:{token:e}})},L=()=>{const e=window.sessionStorage.getItem("previewToken"),n=document.createElement("div");n.id="__nuxt_preview_wrapper",document.body.appendChild(n),z(H,{previewToken:e,apiURL:s==null?void 0:s.apiURL,syncPreview:y,requestPreviewSyncAPI:$}).mount(n)},T=async e=>{var c,f,t;const n=window.sessionStorage.getItem("previewToken");if(!e)return null;e=e.replace(/\/$/,"");let a=await((c=r.value)==null?void 0:c.getItem(`${n}:${e}`));return a||(a=await((f=r.value)==null?void 0:f.getItem(`cached:${e}`))),a||(a=a=await((t=r.value)==null?void 0:t.getItem(e))),a},K=e=>{var a;const n=window.sessionStorage.getItem("previewToken");r.value&&r.value.setItem(`${n}:${(a=e.parsed)==null?void 0:a._id}`,JSON.stringify(e.parsed))},N=async e=>{var a;const n=window.sessionStorage.getItem("previewToken");await((a=r.value)==null?void 0:a.removeItem(`${n}:${e}`))},x=async()=>{if(d!=null&&d.documentDriven){const{pages:e}=P(o,G);for(const n in e.value)e.value[n]&&(e.value[n]=await T(e.value[n]._id))}P(o,Q)};return{apiURL:s==null?void 0:s.apiURL,contentStorage:r,syncPreviewFiles:i,syncPreviewAppConfig:w,syncPreviewTokensConfig:l,requestPreviewSynchronization:$,findContentWithId:T,updateContent:K,removeContentWithId:N,requestRerender:x,mountPreviewUI:L,initiateIframeCommunication:U};function U(){if(!window.parent||window.self===window.parent)return;const e=W(),n=R(),a=B(""),c=t=>({path:t.path,query:A(t.query),params:A(t.params),fullPath:t.fullPath,meta:A(t.meta)});window.addEventListener("keydown",t=>{(t.metaKey||t.ctrlKey||t.altKey||t.shiftKey)&&window.parent.postMessage({type:"nuxt-studio:preview:keydown",payload:{key:t.key,metaKey:t.metaKey,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey}},"*")}),window.addEventListener("message",async t=>{const{type:p,payload:I={}}=t.data||{};switch(p){case"nuxt-studio:editor:file-selected":{const h=await T(I.path);h&&(h._partial||h._path!==R().path&&(a.value=h._path,e.push(h._path)));break}case"nuxt-studio:editor:file-changed":{const{additions:h=[],deletions:S=[]}=I;for(const m of h)await K(m);for(const m of S)await N(m.path);x();break}case"nuxt-studio:preview:sync":{y(I);break}case"nuxt-studio:config:file-changed":{const{additions:h=[],deletions:S=[]}=I,m=h.find(k=>k.path===v.appConfig);m&&w(m==null?void 0:m.parsed),S.find(k=>k.path===v.appConfig)&&w(void 0);const _=h.find(k=>k.path===v.tokensConfig);_&&l(_==null?void 0:_.parsed),S.find(k=>k.path===v.tokensConfig)&&l(void 0);break}}}),o.hook("page:finish",()=>{f()}),o.hook("content:document-driven:finish",({route:t,page:p})=>{t.meta.studio_page_contentId=p==null?void 0:p._id}),o.hook("nuxt-studio:preview:ready",()=>{window.parent.postMessage({type:"nuxt-studio:preview:ready",payload:c(R())},"*"),setTimeout(()=>{f()},100)});function f(){const t=Array.from(window.document.querySelectorAll("[data-content-id]")).map(I=>I.getAttribute("data-content-id")),p=Array.from(new Set([n.meta.studio_page_contentId,...t])).filter(Boolean);if(a.value===p[0]){a.value="";return}window.openContentInStudioEditor(p,{navigate:!0,pageContentId:n.meta.studio_page_contentId})}window.openContentInStudioEditor=(t,p={})=>{window.parent.postMessage({type:"nuxt-studio:preview:navigate",payload:{...c(n),contentIds:t,...p}},"*")}}};export{oe as useStudio};
